rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // HELPER FUNCTIONS
    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      // Check for the 'admin' custom claim.
      return isAuth() && request.auth.token.admin == true;
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // RULES FOR COLLECTIONS
    match /users/{userId} {
      // Admins can list and read all users.
      // Users can only read/write their own document.
      allow list, read: if isAdmin();
      allow get, write: if isOwner(userId) || isAdmin();
    }

    match /repairs/{repairId} {
      // Users can read their own repairs, admins can read all repairs
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow list: if isAuth();
      
      // Authenticated users can create repairs.
      allow create: if isAuth();

      // Owners and Admins can update/delete.
      allow update, delete: if isOwner(resource.data.userId) || isAdmin();
    }

    match /inventory/{itemId} {
        // Admins can manage inventory. Authenticated users can read it.
        allow read: if isAuth();
        allow write, create, delete, list: if isAdmin();
    }

    match /notifications/{notificationId} {
      // Admins can access any notification.
      // Users can only access their own.
      allow read, write, list: if isAdmin() || (isAuth() && resource.data.userId == request.auth.uid);
    }

    match /promotions/{promotionId} {
      // Authenticated users can read promotions.
      // Admins can manage them.
      allow read: if isAuth();
      allow write, create, delete, list: if isAdmin();
    }
  }
}