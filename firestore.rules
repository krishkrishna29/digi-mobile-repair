rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {


    // =========================
    // Helper Functions
    // =========================
    function isAuth() {
      // User must be authenticated.
      return request.auth != null;
    }

    function getUserRole(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }

    function isAdmin() {
      return isAuth() && getUserRole(request.auth.uid) == 'admin';
    }

    function isTechnician() {
      return isAuth() && getUserRole(request.auth.uid) == 'technician';
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // =========================
    // USERS
    // =========================
    match /users/{userId} {
      allow read: if isAuth();
      allow write: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // =========================
    // COUNTERS
    // =========================
    match /counters/{counterId} {
      allow read: if isAuth();
      allow write: if isAuth(); // For transactions
    }

    // =========================
    // REPAIRS
    // =========================
    match /repairs/{repairId} {
      allow read, update: if isAuth() && (isOwner(resource.data.userId) || isAdmin() || isTechnician());
      allow create: if isAuth();
      allow delete: if isAdmin();
    }

    // =========================
    // NOTIFICATIONS (User-facing)
    // =========================
    match /notifications/{notificationId} {
      allow read, delete: if isAuth() && (isOwner(resource.data.userId) || isAdmin() || resource.data.userId == 'all');
      allow create: if isAuth() && (isOwner(request.resource.data.userId) || isAdmin());
      allow update: if isAuth() && isOwner(resource.data.userId);
    }

    // =========================
    // ADMIN NOTIFICATIONS
    // =========================
    match /admin_notifications/{notificationId} {
      allow read, update, delete: if isAdmin();
      allow create: if isAuth();
    }

    // =========================
    // CHATS
    // =========================
    match /chats/{chatId} {
      allow read, create: if isAuth() && (isOwner(get(/databases/$(database)/documents/repairs/$(request.resource.data.repairId)).data.userId) || isAdmin() || isTechnician());
      allow update, delete: if isAdmin();
    }

    // =========================
    // ADMIN-ONLY COLLECTIONS
    // =========================
    match /inventory/{itemId} {
      allow read, write, create, delete: if isAdmin();
    }
    
    match /promotions/{promotionId} {
      allow read: if true; // Promotions are public
      allow write, create, delete: if isAdmin();
    }

    // =========================
    // SETTINGS (This is the new part)
    // =========================
    match /settings/invoice {
        allow read: if isAuth();
        allow write: if isAdmin();
    }

  }
}