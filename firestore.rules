rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================
    // Helper Functions
    // =========================
    function isAuth() {
      return request.auth != null;
    }

    function getUserRole(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }

    function isAdmin() {
      return isAuth() && getUserRole(request.auth.uid) == 'admin';
    }

    function isTechnician() {
      return isAuth() && getUserRole(request.auth.uid) == 'technician';
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // =========================
    // USERS
    // =========================
    match /users/{userId} {
      allow read: if isAuth();
      allow write: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // =========================
    // REPAIRS
    // =========================
    match /repairs/{repairId} {
      allow read: if isAuth() && (isOwner(resource.data.userId) || isAdmin() || (isTechnician() && resource.data.assignedTo == request.auth.uid));
      allow create: if isAuth() && isOwner(request.resource.data.userId);
      allow update: if (isAdmin() || 
                       (isTechnician() && resource.data.assignedTo == request.auth.uid) ||
                       (isOwner(resource.data.userId) && resource.data.status == 'Diagnosed' && request.resource.data.status in ['Repairing', 'Cancelled']));
      allow delete: if isAdmin();

      match /messages/{messageId} {
        allow read, create: if isAuth() && (isOwner(get(/databases/$(database)/documents/repairs/$(repairId)).data.userId) || isAdmin() || isTechnician());
      }
    }

    // =========================
    // NOTIFICATIONS (User-facing)
    // =========================
    match /notifications/{notificationId} {
      allow read, delete: if isAuth() && (isOwner(resource.data.userId) || isAdmin());
      allow create: if isAuth() && (isOwner(request.resource.data.userId) || isAdmin());
      allow update: if isAuth() && isOwner(resource.data.userId);
    }

    // =========================
    // ADMIN NOTIFICATIONS
    // =========================
    match /admin_notifications/{notificationId} {
      allow read, update, delete: if isAdmin();
      allow create: if isAuth();
    }

    // =========================
    // ADMIN-ONLY COLLECTIONS
    // =========================
    match /inventory/{itemId} {
      allow read, write, create, delete: if isAdmin();
    }
    
    match /promotions/{promotionId} {
      allow read, write, create, delete: if isAdmin();
    }

    match /timeSlots/{slotId} {
        allow read, write, create, delete: if isAdmin();
    }
  }
}
