rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to check user roles by reading the user's document.
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isAuth() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function isRole(role) {
      return isAuth() && getUserData(request.auth.uid).role == role;
    }

    function isAdmin() {
      return isRole('admin');
    }

    function isTechnician() {
      return isRole('technician');
    }

    // USERS: Users can manage their own profile. Admins have full access.
    match /users/{userId} {
      allow read, write: if isUser(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // REPAIRS: Access is based on user roles.
    match /repairs/{repairId} {
      // READ: Allowed if you own the repair, are an admin, or the assigned technician.
      allow read: if isAuth() && (isUser(resource.data.userId) || isAdmin() || (isTechnician() && resource.data.assignedTo == request.auth.uid));

      // CREATE: Any authenticated user can create a repair, but must be for themselves.
      allow create: if isUser(request.resource.data.userId);

      // UPDATE: Permissions are now combined into a single, clear rule.
      allow update: if isAuth() && (
        // Admins have full update power.
        isAdmin() ||
        // Technicians can update if assigned.
        (isTechnician() && resource.data.assignedTo == request.auth.uid) ||
        // Users can only approve/decline a diagnosed repair.
        (isUser(resource.data.userId) && resource.data.status == 'Diagnosed' && request.resource.data.status in ['Repairing', 'Cancelled'])
      );

      // DELETE: Only admins can delete repairs.
      allow delete: if isAdmin();

      // MESSAGES: Subcollection for chat within a repair.
      match /messages/{messageId} {
        allow read, create: if isAuth() && (isUser(get(/databases/$(database)/documents/repairs/$(repairId)).data.userId) || isAdmin() || isTechnician());
      }
    }

    // NOTIFICATIONS: Users can access their own. Admins can access all.
    match /notifications/{notificationId} {
      allow read, write, delete: if isAuth() && (isUser(resource.data.userId) || isAdmin());
    }
    
    // Admin-only collections.
    match /inventory/{itemId} { allow read, write: if isAdmin(); }
    match /promotions/{promotionId} { allow read, write: if isAdmin(); }
    match /timeSlots/{slotId} { allow read, write: if isAdmin(); }
  }
}
